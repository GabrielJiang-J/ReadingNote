    hw期间，在公司事情比较少，就把之前没有系统研究过的二进制格式、linux c程序的从源码到二进制文件的转换以及二进制文件的装载和执行，再从头到尾捋一遍，把底层的原理弄清楚，让以前隐藏在迷雾中的摸棱两可的知识，一点一点呈现出来，也能让自己的基础更扎实些。

### 1. c源码设计
    经过对各种设计类、架构类书籍的洗礼，应该可以“设计”出比较牛逼的软件架构了，然后就拿着各种编辑器啊、ide啊开始一顿写代码。
    设计这块儿的内容，主要集中c的基础、c的高级技术、linux系统编程、linux网络编程、并行编程、IPC技术、内核编程等等，基础的编程技术的学习。还有操作系统、编译原理、网络原理、计算机体系结构、算法、架构设计、重构、系统分析、设计模式等等技术的学习。然后就是夜以继日无休止的撸代码，打副本升级。

### 2. c源码编写
    然后在经历无数昼夜的百度、狗狗之后，终于把贼牛逼的架构实现了，虽然对写的什么东西一脸懵逼，但不耽误完成领导布置的任务，妹汁儿汁儿。

---
    吭哧吭哧，终于把代码写完了，然后就是编译、执行。好像很自然的操作，但是这两部操作到底干了啥？我完全不知道，完全是傻子一样，等着计算机帮我处理好。所以，后面进入到linux c程序的编译阶段。

### 3. gcc预处理：cpp
### 4. gcc编译：cc1
### 5. gcc汇编：as
#### elf文件格式
    汇编之后会产生relocatable file，relocatable file是c程序生命周期中第一个以elf格式存在的文件，后面还有executable file和shared object file都是以elf格式存在，并且在elf定义中，都属于object file，因此在这里记录elf文件格式。
    elf截至当前为止，分为两部分。一个是32位标准定义，一个是64位补充定义。在标准中没有定义的部分，属于实现相关的部分，可以参考linux系统下的/usr/include/elf.h中的定义。
> [elf 32位标准定义](https://github.com/GabrielJiang-J/study_information/blob/master/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/linux/elf.pdf)
> [elf 64位补充定义](https://github.com/GabrielJiang-J/study_information/blob/master/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/linux/elf-64-gen.pdf)

    鉴于目前64位已比较普遍，所以在记录时，直接合并32位和64位定义中的相关数据结构定义。

---
    
   object file会参与到程序的链接和执行过程中，因此elf文件划分出链接视图和执行视图，两种视图来体现链接和执行过程中的不同要素。
![Object File Format](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\1.png) 
> **ELF header**：描述了整个elf的结构和组织。
> **Sections**：包含所有“链接视图”所需的信息。
> **Segments**：包含所有“执行视图”所需的信息。
> **program header table**：定义如何创建process image。
> **section header table**：包含所有section的全部信息。

### ELF Header

![ELF-64 Data Types](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\2.png)
    
![ELF-64 Header](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\3.png)

![ELF Identification, e_ident](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\4.png)

![Object File Classes, e_ident[EI_CLASS]](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\5.png)

![Data Encodings, e_ident[EI_DATA]](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\6.png)

![Operating System and ABI Identifiers, e_ident[EI_OSABI]](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\7.png)

![Object File Types, e_type](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\8.png)

![e_machine](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\9.png)


实例：
```shell
[root@localhost tmp]# readelf -h /bin/ls
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x404324
  Start of program headers:          64 (bytes into file)
  Start of section headers:          115688 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         30
  Section header string table index: 29
```
```shell
[root@localhost tmp]# xxd -s 0x0 -l 0x40 /bin/ls
0000000: 7f45 4c46 0201 0100 0000 0000 0000 0000  .ELF............
0000010: 0200 3e00 0100 0000 2443 4000 0000 0000  ..>.....$C@.....
0000020: 4000 0000 0000 0000 e8c3 0100 0000 0000  @...............
0000030: 0000 0000 4000 3800 0900 4000 1e00 1d00  ....@.8...@.....
```

#### Section

![ELF-64 Section Header](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\10.png)

![Section Types, sh_type](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\11.png)

![Section Attributes, sh_flags](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\12.png)

![Use of the sh_link Field](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\13.png)

![Use of the sh_info Field](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\14.png)

![Standard Sections for Code and Data](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\15.png)

![Other Standard Sections](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\16.png)

```shell
[root@localhost 3]# readelf -S /bin/ls
There are 30 section headers, starting at offset 0x1c3e8:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .interp           PROGBITS         0000000000400238  00000238
       000000000000001c  0000000000000000   A       0     0     1
  [ 2] .note.ABI-tag     NOTE             0000000000400254  00000254
       0000000000000020  0000000000000000   A       0     0     4
  [ 3] .note.gnu.build-i NOTE             0000000000400274  00000274
       0000000000000024  0000000000000000   A       0     0     4
  [ 4] .gnu.hash         GNU_HASH         0000000000400298  00000298
       0000000000000038  0000000000000000   A       5     0     8
  [ 5] .dynsym           DYNSYM           00000000004002d0  000002d0
       0000000000000c18  0000000000000018   A       6     1     8
  [ 6] .dynstr           STRTAB           0000000000400ee8  00000ee8
       0000000000000572  0000000000000000   A       0     0     1
  [ 7] .gnu.version      VERSYM           000000000040145a  0000145a
       0000000000000102  0000000000000002   A       5     0     2
  [ 8] .gnu.version_r    VERNEED          0000000000401560  00001560
       0000000000000090  0000000000000000   A       6     2     8
  [ 9] .rela.dyn         RELA             00000000004015f0  000015f0
       00000000000000d8  0000000000000018   A       5     0     8
  [10] .rela.plt         RELA             00000000004016c8  000016c8
       0000000000000ac8  0000000000000018  AI       5    24     8
  [11] .init             PROGBITS         0000000000402190  00002190
       000000000000001a  0000000000000000  AX       0     0     4
  [12] .plt              PROGBITS         00000000004021b0  000021b0
       0000000000000740  0000000000000010  AX       0     0     16
  [13] .text             PROGBITS         00000000004028f0  000028f0
       000000000001014a  0000000000000000  AX       0     0     16
  [14] .fini             PROGBITS         0000000000412a3c  00012a3c
       0000000000000009  0000000000000000  AX       0     0     4
  [15] .rodata           PROGBITS         0000000000412a60  00012a60
       0000000000003cce  0000000000000000   A       0     0     32
  [16] .eh_frame_hdr     PROGBITS         0000000000416730  00016730
       0000000000000754  0000000000000000   A       0     0     4
  [17] .eh_frame         PROGBITS         0000000000416e88  00016e88
       0000000000002704  0000000000000000   A       0     0     8
  [18] .init_array       INIT_ARRAY       000000000061a328  0001a328
       0000000000000008  0000000000000008  WA       0     0     8
  [19] .fini_array       FINI_ARRAY       000000000061a330  0001a330
       0000000000000008  0000000000000008  WA       0     0     8
  [20] .jcr              PROGBITS         000000000061a338  0001a338
       0000000000000008  0000000000000000  WA       0     0     8
  [21] .data.rel.ro      PROGBITS         000000000061a340  0001a340
       0000000000000a68  0000000000000000  WA       0     0     32
  [22] .dynamic          DYNAMIC          000000000061ada8  0001ada8
       0000000000000200  0000000000000010  WA       6     0     8
  [23] .got              PROGBITS         000000000061afa8  0001afa8
       0000000000000048  0000000000000008  WA       0     0     8
  [24] .got.plt          PROGBITS         000000000061b000  0001b000
       00000000000003b0  0000000000000008  WA       0     0     8
  [25] .data             PROGBITS         000000000061b3c0  0001b3c0
       0000000000000240  0000000000000000  WA       0     0     32
  [26] .bss              NOBITS           000000000061b600  0001b600
       0000000000000d20  0000000000000000  WA       0     0     32
  [27] .gnu_debuglink    PROGBITS         0000000000000000  0001b600
       0000000000000010  0000000000000000           0     0     4
  [28] .gnu_debugdata    PROGBITS         0000000000000000  0001b610
       0000000000000cb8  0000000000000000           0     0     1
  [29] .shstrtab         STRTAB           0000000000000000  0001c2c8
       000000000000011a  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)
```

```shell
[root@localhost 3]# xxd -s 0x1c3e8 -l 0x780 /bin/ls
001c3e8: 0000 0000 0000 0000 0000 0000 0000 0000  ................
001c3f8: 0000 0000 0000 0000 0000 0000 0000 0000  ................
001c408: 0000 0000 0000 0000 0000 0000 0000 0000  ................
001c418: 0000 0000 0000 0000 0000 0000 0000 0000  ................
001c428: 0b00 0000 0100 0000 0200 0000 0000 0000  ................
001c438: 3802 4000 0000 0000 3802 0000 0000 0000  8.@.....8.......
001c448: 1c00 0000 0000 0000 0000 0000 0000 0000  ................
001c458: 0100 0000 0000 0000 0000 0000 0000 0000  ................
001c468: 1300 0000 0700 0000 0200 0000 0000 0000  ................
001c478: 5402 4000 0000 0000 5402 0000 0000 0000  T.@.....T.......
001c488: 2000 0000 0000 0000 0000 0000 0000 0000   ...............
001c498: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001c4a8: 2100 0000 0700 0000 0200 0000 0000 0000  !...............
001c4b8: 7402 4000 0000 0000 7402 0000 0000 0000  t.@.....t.......
001c4c8: 2400 0000 0000 0000 0000 0000 0000 0000  $...............
001c4d8: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001c4e8: 3400 0000 f6ff ff6f 0200 0000 0000 0000  4......o........
001c4f8: 9802 4000 0000 0000 9802 0000 0000 0000  ..@.............
001c508: 3800 0000 0000 0000 0500 0000 0000 0000  8...............
001c518: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c528: 3e00 0000 0b00 0000 0200 0000 0000 0000  >...............
001c538: d002 4000 0000 0000 d002 0000 0000 0000  ..@.............
001c548: 180c 0000 0000 0000 0600 0000 0100 0000  ................
001c558: 0800 0000 0000 0000 1800 0000 0000 0000  ................
001c568: 4600 0000 0300 0000 0200 0000 0000 0000  F...............
001c578: e80e 4000 0000 0000 e80e 0000 0000 0000  ..@.............
001c588: 7205 0000 0000 0000 0000 0000 0000 0000  r...............
001c598: 0100 0000 0000 0000 0000 0000 0000 0000  ................
001c5a8: 4e00 0000 ffff ff6f 0200 0000 0000 0000  N......o........
001c5b8: 5a14 4000 0000 0000 5a14 0000 0000 0000  Z.@.....Z.......
001c5c8: 0201 0000 0000 0000 0500 0000 0000 0000  ................
001c5d8: 0200 0000 0000 0000 0200 0000 0000 0000  ................
001c5e8: 5b00 0000 feff ff6f 0200 0000 0000 0000  [......o........
001c5f8: 6015 4000 0000 0000 6015 0000 0000 0000  `.@.....`.......
001c608: 9000 0000 0000 0000 0600 0000 0200 0000  ................
001c618: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c628: 6a00 0000 0400 0000 0200 0000 0000 0000  j...............
001c638: f015 4000 0000 0000 f015 0000 0000 0000  ..@.............
001c648: d800 0000 0000 0000 0500 0000 0000 0000  ................
001c658: 0800 0000 0000 0000 1800 0000 0000 0000  ................
001c668: 7400 0000 0400 0000 4200 0000 0000 0000  t.......B.......
001c678: c816 4000 0000 0000 c816 0000 0000 0000  ..@.............
001c688: c80a 0000 0000 0000 0500 0000 1800 0000  ................
001c698: 0800 0000 0000 0000 1800 0000 0000 0000  ................
001c6a8: 7e00 0000 0100 0000 0600 0000 0000 0000  ~...............
001c6b8: 9021 4000 0000 0000 9021 0000 0000 0000  .!@......!......
001c6c8: 1a00 0000 0000 0000 0000 0000 0000 0000  ................
001c6d8: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001c6e8: 7900 0000 0100 0000 0600 0000 0000 0000  y...............
001c6f8: b021 4000 0000 0000 b021 0000 0000 0000  .!@......!......
001c708: 4007 0000 0000 0000 0000 0000 0000 0000  @...............
001c718: 1000 0000 0000 0000 1000 0000 0000 0000  ................
001c728: 8400 0000 0100 0000 0600 0000 0000 0000  ................
001c738: f028 4000 0000 0000 f028 0000 0000 0000  .(@......(......
001c748: 4a01 0100 0000 0000 0000 0000 0000 0000  J...............
001c758: 1000 0000 0000 0000 0000 0000 0000 0000  ................
001c768: 8a00 0000 0100 0000 0600 0000 0000 0000  ................
001c778: 3c2a 4100 0000 0000 3c2a 0100 0000 0000  <*A.....<*......
001c788: 0900 0000 0000 0000 0000 0000 0000 0000  ................
001c798: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001c7a8: 9000 0000 0100 0000 0200 0000 0000 0000  ................
001c7b8: 602a 4100 0000 0000 602a 0100 0000 0000  `*A.....`*......
001c7c8: ce3c 0000 0000 0000 0000 0000 0000 0000  .<..............
001c7d8: 2000 0000 0000 0000 0000 0000 0000 0000   ...............
001c7e8: 9800 0000 0100 0000 0200 0000 0000 0000  ................
001c7f8: 3067 4100 0000 0000 3067 0100 0000 0000  0gA.....0g......
001c808: 5407 0000 0000 0000 0000 0000 0000 0000  T...............
001c818: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001c828: a600 0000 0100 0000 0200 0000 0000 0000  ................
001c838: 886e 4100 0000 0000 886e 0100 0000 0000  .nA......n......
001c848: 0427 0000 0000 0000 0000 0000 0000 0000  .'..............
001c858: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c868: b000 0000 0e00 0000 0300 0000 0000 0000  ................
001c878: 28a3 6100 0000 0000 28a3 0100 0000 0000  (.a.....(.......
001c888: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c898: 0800 0000 0000 0000 0800 0000 0000 0000  ................
001c8a8: bc00 0000 0f00 0000 0300 0000 0000 0000  ................
001c8b8: 30a3 6100 0000 0000 30a3 0100 0000 0000  0.a.....0.......
001c8c8: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c8d8: 0800 0000 0000 0000 0800 0000 0000 0000  ................
001c8e8: c800 0000 0100 0000 0300 0000 0000 0000  ................
001c8f8: 38a3 6100 0000 0000 38a3 0100 0000 0000  8.a.....8.......
001c908: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c918: 0800 0000 0000 0000 0000 0000 0000 0000  ................
001c928: cd00 0000 0100 0000 0300 0000 0000 0000  ................
001c938: 40a3 6100 0000 0000 40a3 0100 0000 0000  @.a.....@.......
001c948: 680a 0000 0000 0000 0000 0000 0000 0000  h...............
001c958: 2000 0000 0000 0000 0000 0000 0000 0000   ...............
001c968: da00 0000 0600 0000 0300 0000 0000 0000  ................
001c978: a8ad 6100 0000 0000 a8ad 0100 0000 0000  ..a.............
001c988: 0002 0000 0000 0000 0600 0000 0000 0000  ................
001c998: 0800 0000 0000 0000 1000 0000 0000 0000  ................
001c9a8: e300 0000 0100 0000 0300 0000 0000 0000  ................
001c9b8: a8af 6100 0000 0000 a8af 0100 0000 0000  ..a.............
001c9c8: 4800 0000 0000 0000 0000 0000 0000 0000  H...............
001c9d8: 0800 0000 0000 0000 0800 0000 0000 0000  ................
001c9e8: e800 0000 0100 0000 0300 0000 0000 0000  ................
001c9f8: 00b0 6100 0000 0000 00b0 0100 0000 0000  ..a.............
001ca08: b003 0000 0000 0000 0000 0000 0000 0000  ................
001ca18: 0800 0000 0000 0000 0800 0000 0000 0000  ................
001ca28: f100 0000 0100 0000 0300 0000 0000 0000  ................
001ca38: c0b3 6100 0000 0000 c0b3 0100 0000 0000  ..a.............
001ca48: 4002 0000 0000 0000 0000 0000 0000 0000  @...............
001ca58: 2000 0000 0000 0000 0000 0000 0000 0000   ...............
001ca68: f700 0000 0800 0000 0300 0000 0000 0000  ................
001ca78: 00b6 6100 0000 0000 00b6 0100 0000 0000  ..a.............
001ca88: 200d 0000 0000 0000 0000 0000 0000 0000   ...............
001ca98: 2000 0000 0000 0000 0000 0000 0000 0000   ...............
001caa8: fc00 0000 0100 0000 0000 0000 0000 0000  ................
001cab8: 0000 0000 0000 0000 00b6 0100 0000 0000  ................
001cac8: 1000 0000 0000 0000 0000 0000 0000 0000  ................
001cad8: 0400 0000 0000 0000 0000 0000 0000 0000  ................
001cae8: 0b01 0000 0100 0000 0000 0000 0000 0000  ................
001caf8: 0000 0000 0000 0000 10b6 0100 0000 0000  ................
001cb08: b80c 0000 0000 0000 0000 0000 0000 0000  ................
001cb18: 0100 0000 0000 0000 0000 0000 0000 0000  ................
001cb28: 0100 0000 0300 0000 0000 0000 0000 0000  ................
001cb38: 0000 0000 0000 0000 c8c2 0100 0000 0000  ................
001cb48: 1a01 0000 0000 0000 0000 0000 0000 0000  ................
001cb58: 0100 0000 0000 0000 0000 0000 0000 0000  ................
```

##### Symble Table 
    符号表包含了所有的在文件中需要定位和重定位的符号定义和引用的信息。

![ELF-64 Symbol Table Entry](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\17.png)

![Symbol Bindings](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\18.png)

![Symbol Types](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\19.png)

![Symbol Types (Continued)](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\19_1.png)

`[root@localhost tmp]# cat HelloWorld.c`
```c
#include <stdio.h>

int main(void) {
    printf("Hello World!\n");

    return 0;
}
```
`[root@localhost tmp]# gcc HelloWorld.c -o HelloWorld`

```shell
[root@localhost tmp]# readelf -S HelloWorld
  [26] .symtab           SYMTAB           0000000000000000  00001080
       00000000000005a0  0000000000000018          27    43     8
```

```shell
[root@localhost tmp]# readelf -s HelloWorld 

Symbol table '.dynsym' contains 4 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@GLIBC_2.2.5 (2)
     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.2.5 (2)
     3: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__

Symbol table '.symtab' contains 60 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000400238     0 SECTION LOCAL  DEFAULT    1 
     2: 0000000000400254     0 SECTION LOCAL  DEFAULT    2 
     3: 0000000000400274     0 SECTION LOCAL  DEFAULT    3 
     4: 0000000000400298     0 SECTION LOCAL  DEFAULT    4 
     5: 00000000004002b8     0 SECTION LOCAL  DEFAULT    5 
     6: 0000000000400318     0 SECTION LOCAL  DEFAULT    6 
     7: 0000000000400356     0 SECTION LOCAL  DEFAULT    7 
     8: 0000000000400360     0 SECTION LOCAL  DEFAULT    8 
     9: 0000000000400380     0 SECTION LOCAL  DEFAULT    9 
    10: 0000000000400398     0 SECTION LOCAL  DEFAULT   10 
    11: 00000000004003e0     0 SECTION LOCAL  DEFAULT   11 
    12: 0000000000400400     0 SECTION LOCAL  DEFAULT   12 
    13: 0000000000400440     0 SECTION LOCAL  DEFAULT   13 
    14: 00000000004005a4     0 SECTION LOCAL  DEFAULT   14 
    15: 00000000004005b0     0 SECTION LOCAL  DEFAULT   15 
    16: 00000000004005c4     0 SECTION LOCAL  DEFAULT   16 
    17: 00000000004005f8     0 SECTION LOCAL  DEFAULT   17 
    18: 0000000000600e18     0 SECTION LOCAL  DEFAULT   18 
    19: 0000000000600e20     0 SECTION LOCAL  DEFAULT   19 
    20: 0000000000600e28     0 SECTION LOCAL  DEFAULT   20 
    21: 0000000000600ff8     0 SECTION LOCAL  DEFAULT   21 
    22: 0000000000601000     0 SECTION LOCAL  DEFAULT   22 
    23: 0000000000601030     0 SECTION LOCAL  DEFAULT   23 
    24: 0000000000601040     0 SECTION LOCAL  DEFAULT   24 
    25: 0000000000000000     0 SECTION LOCAL  DEFAULT   25 
    26: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
    27: 0000000000400470     0 FUNC    LOCAL  DEFAULT   13 deregister_tm_clones
    28: 00000000004004a0     0 FUNC    LOCAL  DEFAULT   13 register_tm_clones
    29: 00000000004004e0     0 FUNC    LOCAL  DEFAULT   13 __do_global_dtors_aux
    30: 0000000000601040     1 OBJECT  LOCAL  DEFAULT   24 completed.7311
    31: 0000000000600e20     0 OBJECT  LOCAL  DEFAULT   19 __do_global_dtors_aux_fin
    32: 0000000000400510     0 FUNC    LOCAL  DEFAULT   13 frame_dummy
    33: 0000000000600e18     0 OBJECT  LOCAL  DEFAULT   18 __frame_dummy_init_array_
    34: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS HelloWorld.c
    35: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c
    36: 00000000004006e8     0 OBJECT  LOCAL  DEFAULT   17 __FRAME_END__
    37: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS 
    38: 0000000000600e20     0 NOTYPE  LOCAL  DEFAULT   18 __init_array_end
    39: 0000000000600e28     0 OBJECT  LOCAL  DEFAULT   20 _DYNAMIC
    40: 0000000000600e18     0 NOTYPE  LOCAL  DEFAULT   18 __init_array_start
    41: 00000000004005c4     0 NOTYPE  LOCAL  DEFAULT   16 __GNU_EH_FRAME_HDR
    42: 0000000000601000     0 OBJECT  LOCAL  DEFAULT   22 _GLOBAL_OFFSET_TABLE_
    43: 00000000004005a0     2 FUNC    GLOBAL DEFAULT   13 __libc_csu_fini
    44: 0000000000601030     0 NOTYPE  WEAK   DEFAULT   23 data_start
    45: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@@GLIBC_2.2.5
    46: 0000000000601040     0 NOTYPE  GLOBAL DEFAULT   23 _edata
    47: 00000000004005a4     0 FUNC    GLOBAL DEFAULT   14 _fini
    48: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@@GLIBC_
    49: 0000000000601030     0 NOTYPE  GLOBAL DEFAULT   23 __data_start
    50: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__
    51: 0000000000601038     0 OBJECT  GLOBAL HIDDEN    23 __dso_handle
    52: 00000000004005b0     4 OBJECT  GLOBAL DEFAULT   15 _IO_stdin_used
    53: 0000000000400530   101 FUNC    GLOBAL DEFAULT   13 __libc_csu_init
    54: 0000000000601048     0 NOTYPE  GLOBAL DEFAULT   24 _end
    55: 0000000000400440     0 FUNC    GLOBAL DEFAULT   13 _start
    56: 0000000000601040     0 NOTYPE  GLOBAL DEFAULT   24 __bss_start
    57: 0000000000400512    21 FUNC    GLOBAL DEFAULT   13 main
    58: 0000000000601040     0 OBJECT  GLOBAL HIDDEN    23 __TMC_END__
    59: 00000000004003e0     0 FUNC    GLOBAL DEFAULT   11 _init
```

```shell
[root@localhost tmp]# xxd -s 0x1080 -l 0x5a0 HelloWorld 
0001080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0001090: 0000 0000 0000 0000 0000 0000 0300 0100  ................
00010a0: 3802 4000 0000 0000 0000 0000 0000 0000  8.@.............
00010b0: 0000 0000 0300 0200 5402 4000 0000 0000  ........T.@.....
00010c0: 0000 0000 0000 0000 0000 0000 0300 0300  ................
00010d0: 7402 4000 0000 0000 0000 0000 0000 0000  t.@.............
00010e0: 0000 0000 0300 0400 9802 4000 0000 0000  ..........@.....
00010f0: 0000 0000 0000 0000 0000 0000 0300 0500  ................
0001100: b802 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001110: 0000 0000 0300 0600 1803 4000 0000 0000  ..........@.....
0001120: 0000 0000 0000 0000 0000 0000 0300 0700  ................
0001130: 5603 4000 0000 0000 0000 0000 0000 0000  V.@.............
0001140: 0000 0000 0300 0800 6003 4000 0000 0000  ........`.@.....
0001150: 0000 0000 0000 0000 0000 0000 0300 0900  ................
0001160: 8003 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001170: 0000 0000 0300 0a00 9803 4000 0000 0000  ..........@.....
0001180: 0000 0000 0000 0000 0000 0000 0300 0b00  ................
0001190: e003 4000 0000 0000 0000 0000 0000 0000  ..@.............
00011a0: 0000 0000 0300 0c00 0004 4000 0000 0000  ..........@.....
00011b0: 0000 0000 0000 0000 0000 0000 0300 0d00  ................
00011c0: 4004 4000 0000 0000 0000 0000 0000 0000  @.@.............
00011d0: 0000 0000 0300 0e00 a405 4000 0000 0000  ..........@.....
00011e0: 0000 0000 0000 0000 0000 0000 0300 0f00  ................
00011f0: b005 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001200: 0000 0000 0300 1000 c405 4000 0000 0000  ..........@.....
0001210: 0000 0000 0000 0000 0000 0000 0300 1100  ................
0001220: f805 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001230: 0000 0000 0300 1200 180e 6000 0000 0000  ..........`.....
0001240: 0000 0000 0000 0000 0000 0000 0300 1300  ................
0001250: 200e 6000 0000 0000 0000 0000 0000 0000   .`.............
0001260: 0000 0000 0300 1400 280e 6000 0000 0000  ........(.`.....
0001270: 0000 0000 0000 0000 0000 0000 0300 1500  ................
0001280: f80f 6000 0000 0000 0000 0000 0000 0000  ..`.............
0001290: 0000 0000 0300 1600 0010 6000 0000 0000  ..........`.....
00012a0: 0000 0000 0000 0000 0000 0000 0300 1700  ................
00012b0: 3010 6000 0000 0000 0000 0000 0000 0000  0.`.............
00012c0: 0000 0000 0300 1800 4010 6000 0000 0000  ........@.`.....
00012d0: 0000 0000 0000 0000 0000 0000 0300 1900  ................
00012e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00012f0: 0100 0000 0400 f1ff 0000 0000 0000 0000  ................
0001300: 0000 0000 0000 0000 0c00 0000 0200 0d00  ................
0001310: 7004 4000 0000 0000 0000 0000 0000 0000  p.@.............
0001320: 0e00 0000 0200 0d00 a004 4000 0000 0000  ..........@.....
0001330: 0000 0000 0000 0000 2100 0000 0200 0d00  ........!.......
0001340: e004 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001350: 3700 0000 0100 1800 4010 6000 0000 0000  7.......@.`.....
0001360: 0100 0000 0000 0000 4600 0000 0100 1300  ........F.......
0001370: 200e 6000 0000 0000 0000 0000 0000 0000   .`.............
0001380: 6d00 0000 0200 0d00 1005 4000 0000 0000  m.........@.....
0001390: 0000 0000 0000 0000 7900 0000 0100 1200  ........y.......
00013a0: 180e 6000 0000 0000 0000 0000 0000 0000  ..`.............
00013b0: 9800 0000 0400 f1ff 0000 0000 0000 0000  ................
00013c0: 0000 0000 0000 0000 0100 0000 0400 f1ff  ................
00013d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00013e0: a500 0000 0100 1100 e806 4000 0000 0000  ..........@.....
00013f0: 0000 0000 0000 0000 0000 0000 0400 f1ff  ................
0001400: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0001410: b300 0000 0000 1200 200e 6000 0000 0000  ........ .`.....
0001420: 0000 0000 0000 0000 c400 0000 0100 1400  ................
0001430: 280e 6000 0000 0000 0000 0000 0000 0000  (.`.............
0001440: cd00 0000 0000 1200 180e 6000 0000 0000  ..........`.....
0001450: 0000 0000 0000 0000 e000 0000 0000 1000  ................
0001460: c405 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001470: f300 0000 0100 1600 0010 6000 0000 0000  ..........`.....
0001480: 0000 0000 0000 0000 0901 0000 1200 0d00  ................
0001490: a005 4000 0000 0000 0200 0000 0000 0000  ..@.............
00014a0: 5301 0000 2000 1700 3010 6000 0000 0000  S... ...0.`.....
00014b0: 0000 0000 0000 0000 1901 0000 1200 0000  ................
00014c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00014d0: 2b01 0000 1000 1700 4010 6000 0000 0000  +.......@.`.....
00014e0: 0000 0000 0000 0000 1301 0000 1200 0e00  ................
00014f0: a405 4000 0000 0000 0000 0000 0000 0000  ..@.............
0001500: 3201 0000 1200 0000 0000 0000 0000 0000  2...............
0001510: 0000 0000 0000 0000 5101 0000 1000 1700  ........Q.......
0001520: 3010 6000 0000 0000 0000 0000 0000 0000  0.`.............
0001530: 5e01 0000 2000 0000 0000 0000 0000 0000  ^... ...........
0001540: 0000 0000 0000 0000 6d01 0000 1102 1700  ........m.......
0001550: 3810 6000 0000 0000 0000 0000 0000 0000  8.`.............
0001560: 7a01 0000 1100 0f00 b005 4000 0000 0000  z.........@.....
0001570: 0400 0000 0000 0000 8901 0000 1200 0d00  ................
0001580: 3005 4000 0000 0000 6500 0000 0000 0000  0.@.....e.......
0001590: bf00 0000 1000 1800 4810 6000 0000 0000  ........H.`.....
00015a0: 0000 0000 0000 0000 5701 0000 1200 0d00  ........W.......
00015b0: 4004 4000 0000 0000 0000 0000 0000 0000  @.@.............
00015c0: 9901 0000 1000 1800 4010 6000 0000 0000  ........@.`.....
00015d0: 0000 0000 0000 0000 a501 0000 1200 0d00  ................
00015e0: 1205 4000 0000 0000 1500 0000 0000 0000  ..@.............
00015f0: aa01 0000 1102 1700 4010 6000 0000 0000  ........@.`.....
0001600: 0000 0000 0000 0000 9301 0000 1200 0b00  ................
0001610: e003 4000 0000 0000 0000 0000 0000 0000  ..@.............
```

##### Relocations
![ELF-64 Relocation Entries](D:\文档\技术资源\读书笔记\ReadingNote\linux程序出生入死\20.png)


```c
#define ELF64_R_SYM(i)((i) >> 32)
#define ELF64_R_TYPE(i)((i) & 0xffffffffL)
#define ELF64_R_INFO(s, t)(((s) << 32) + ((t) & 0xffffffffL))
```


```shell
[root@localhost tmp]# gcc -c HelloWorld.c -o HelloWorld.o
[root@localhost tmp]# readelf -S HelloWorld.o

  [ 2] .rela.text        RELA             0000000000000000  000001d0
       0000000000000030  0000000000000018   I      10     1     8
  [ 9] .rela.eh_frame    RELA             0000000000000000  00000200
       0000000000000018  0000000000000018   I      10     8     8


[root@localhost tmp]# readelf -r HelloWorld.o

Relocation section '.rela.text' at offset 0x1d0 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000005  00050000000a R_X86_64_32       0000000000000000 .rodata + 0
00000000000a  000a00000002 R_X86_64_PC32     0000000000000000 puts - 4

Relocation section '.rela.eh_frame' at offset 0x200 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0

[root@localhost tmp]# xxd -s 0x1d0 -l 0x30 HelloWorld.o
00001d0: 0500 0000 0000 0000 0a00 0000 0500 0000  ................
00001e0: 0000 0000 0000 0000 0a00 0000 0000 0000  ................
00001f0: 0200 0000 0a00 0000 fcff ffff ffff ffff  ................

[root@localhost tmp]# readelf -S HelloWorld

  [ 9] .rela.dyn         RELA             0000000000400380  00000380
       0000000000000018  0000000000000018   A       5     0     8
  [10] .rela.plt         RELA             0000000000400398  00000398
       0000000000000048  0000000000000018  AI       5    22     8

[root@localhost tmp]# readelf -r HelloWorld

Relocation section '.rela.dyn' at offset 0x380 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000600ff8  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section '.rela.plt' at offset 0x398 contains 3 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000601018  000100000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
000000601020  000200000007 R_X86_64_JUMP_SLO 0000000000000000 __libc_start_main@GLIBC_2.2.5 + 0
000000601028  000300000007 R_X86_64_JUMP_SLO 0000000000000000 __gmon_start__ + 0

[root@localhost tmp]# xxd -s 0x398 -l 0x48 HelloWorld
0000398: 1810 6000 0000 0000 0700 0000 0100 0000  ..`.............
00003a8: 0000 0000 0000 0000 2010 6000 0000 0000  ........ .`.....
00003b8: 0700 0000 0200 0000 0000 0000 0000 0000  ................
00003c8: 2810 6000 0000 0000 0700 0000 0300 0000  (.`.............
00003d8: 0000 0000 0000 0000                      ........

```
    
---
### 6. gcc链接：collect2:ld//lib64/ld-linux-x86-64.so.2
#### 动态链接
实验：
`[root@localhost 3]# cat Program1.c`
```c
#include "Lib.h"

int main(void) {
   foobar(1); 
   return 0;
}
```

`[root@localhost 3]# cat Program2.c`
```c
#include "Lib.h"

int main(void) {
   foobar(2); 
   return 0;
}
```

`[root@localhost 3]# cat Lib.c`
```c
#include <stdio.h>

void foobar(int i) {
    printf("Printing from Lib.so %d\n", i);
}
```

`[root@localhost 3]# cat Lib.h`
```c
#ifndef LIB_H
#define LIB_H

void foobar(int i);

#endif
```

```shell
[root@localhost 3]# gcc -fPIC -shared -o Lib.so Lib.c 
[root@localhost 3]# gcc -o Program1 Program1.c ./Lib.so 
[root@localhost 3]# gcc -o Program2 Program2.c ./Lib.so
```

### 7. elf装载

program headers
```c
int main(void) {
    int a = 0x12345678;

    return 0;
}
```
```
[root@localhost tmp]# readelf -l test

Elf file type is EXEC (Executable file)
Entry point 0x400400
There are 9 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040
                 0x00000000000001f8 0x00000000000001f8  R E    8
  INTERP         0x0000000000000238 0x0000000000400238 0x0000000000400238
                 0x000000000000001c 0x000000000000001c  R      1
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
                 0x000000000000069c 0x000000000000069c  R E    200000
  LOAD           0x0000000000000e18 0x0000000000600e18 0x0000000000600e18
                 0x0000000000000220 0x0000000000000228  RW     200000
  DYNAMIC        0x0000000000000e28 0x0000000000600e28 0x0000000000600e28
                 0x00000000000001d0 0x00000000000001d0  RW     8
  NOTE           0x0000000000000254 0x0000000000400254 0x0000000000400254
                 0x0000000000000044 0x0000000000000044  R      4
  GNU_EH_FRAME   0x0000000000000574 0x0000000000400574 0x0000000000400574
                 0x0000000000000034 0x0000000000000034  R      4
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     10
  GNU_RELRO      0x0000000000000e18 0x0000000000600e18 0x0000000000600e18
                 0x00000000000001e8 0x00000000000001e8  R      1

 Section to Segment mapping:
  Segment Sections...
   00     
   01     .interp 
   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame 
   03     .init_array .fini_array .dynamic .got .got.plt .data .bss 
   04     .dynamic 
   05     .note.ABI-tag .note.gnu.build-id 
   06     .eh_frame_hdr 
   07     
   08     .init_array .fini_array .dynamic .got 
```
```
[root@localhost tmp]# xxd -s 0x40 -l 0x1f8 /tmp/test
0000040: 0600 0000 0500 0000 4000 0000 0000 0000  ........@.......
0000050: 4000 4000 0000 0000 4000 4000 0000 0000  @.@.....@.@.....
0000060: f801 0000 0000 0000 f801 0000 0000 0000  ................
0000070: 0800 0000 0000 0000 0300 0000 0400 0000  ................
0000080: 3802 0000 0000 0000 3802 4000 0000 0000  8.......8.@.....
0000090: 3802 4000 0000 0000 1c00 0000 0000 0000  8.@.............
00000a0: 1c00 0000 0000 0000 0100 0000 0000 0000  ................
00000b0: 0100 0000 0500 0000 0000 0000 0000 0000  ................
00000c0: 0000 4000 0000 0000 0000 4000 0000 0000  ..@.......@.....
00000d0: 9c06 0000 0000 0000 9c06 0000 0000 0000  ................
00000e0: 0000 2000 0000 0000 0100 0000 0600 0000  .. .............
00000f0: 180e 0000 0000 0000 180e 6000 0000 0000  ..........`.....
0000100: 180e 6000 0000 0000 2002 0000 0000 0000  ..`..... .......
0000110: 2802 0000 0000 0000 0000 2000 0000 0000  (......... .....
0000120: 0200 0000 0600 0000 280e 0000 0000 0000  ........(.......
0000130: 280e 6000 0000 0000 280e 6000 0000 0000  (.`.....(.`.....
0000140: d001 0000 0000 0000 d001 0000 0000 0000  ................
0000150: 0800 0000 0000 0000 0400 0000 0400 0000  ................
0000160: 5402 0000 0000 0000 5402 4000 0000 0000  T.......T.@.....
0000170: 5402 4000 0000 0000 4400 0000 0000 0000  T.@.....D.......
0000180: 4400 0000 0000 0000 0400 0000 0000 0000  D...............
0000190: 50e5 7464 0400 0000 7405 0000 0000 0000  P.td....t.......
00001a0: 7405 4000 0000 0000 7405 4000 0000 0000  t.@.....t.@.....
00001b0: 3400 0000 0000 0000 3400 0000 0000 0000  4.......4.......
00001c0: 0400 0000 0000 0000 51e5 7464 0600 0000  ........Q.td....
00001d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00001e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00001f0: 0000 0000 0000 0000 1000 0000 0000 0000  ................
0000200: 52e5 7464 0400 0000 180e 0000 0000 0000  R.td............
0000210: 180e 6000 0000 0000 180e 6000 0000 0000  ..`.......`.....
0000220: e801 0000 0000 0000 e801 0000 0000 0000  ................
0000230: 0100 0000 0000 0000                      ........
```
```
[root@localhost tmp]# xxd -s 0x40 -l 56 /tmp/test
0000040: 0600 0000 0500 0000 4000 0000 0000 0000  ........@.......
0000050: 4000 4000 0000 0000 4000 4000 0000 0000  @.@.....@.@.....
0000060: f801 0000 0000 0000 f801 0000 0000 0000  ................
0000070: 0800 0000 0000 0000                      ........
```
    > ELF二进制文件load到内存并执行，内核源码：
    > https://github.com/GabrielJiang-J/study_information/blob/master/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/linux/elf-64-gen.pdf
    > linux-2.6.34/fs/binfmt_elf.c:elf_format.load_binary
    > linux-2.6.34/arch/ia64/kernel/process.c:sys_execve
### 8. elf执行
